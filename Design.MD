
# 功能设计

术语

脚本类型 = Python | Bash
脚本代码 = 代码数据 + 脚本类型
状态 = 新添加 | 正在运行 | 已退出 + 间隔时间
间隔时间 = (int >= 0)
ID = (int >= 0)
任务 = ID + 标题（唯一） + 脚本代码 + 状态 + 间隔时间
任务列表 = [ 任务, 任务, ... ]

1. 显示任务列表
   1. 描述：用户打开页面后看到任务列表；列表每项包含任务的标题、任务的状态（文本）、间隔时间、下一次运行时间、启动/停止/删除该任务
   2. 流程
      1. 前端向后端发送获取任务列表请求
      2. 后端从数据库读取所有任务列表及状态，发送到前端
      3. 前端展示任务列表
2. 添加任务
   1. 描述：用户在文本区域输入脚本代码；选择脚本类型；设置间隔时间（默认为0）；点击添加
   2. 流程
      1. 前端提取任务数据并处理为JSON字符串，发送到后端；
      2. 后端接收到任务后，解析为任务对象，并将对象添加到数据库中；
      3. 后端完成后向前端发送确认码；
      4. 前端收到确认码后刷新任务列表
3. 启动任务
   1. 描述：用户点击未启动任务的启动按钮，启动该任务
   2. 流程
      1. 前端将启动任务请求发送到后端
      2. 后端启动任务
         1. 后端从数据库读取任务信息，将任务的脚本代码写入到文件中
         2. 后端创建新进程，将进程的三个STDIO重定向到三个管道，并在主进程中使用IO多路复用监听三个管道
            1. 将STDOUT、STDERR存储到固定大小的缓冲区中
         3. 新进程中执行脚本文件
4. 查看任务信息
   1. 描述：用户点击任务列表某个任务的标题；进入任务信息界面，能够实时看到任务的输出内容
   2. 流程
      1. 进入任务信息界面时，前端向后端发起websocket连接
         1. 前端注册websocket的相关事件：onmessage收取数据显示到STDOUT/STDERR中
         2. 前端使用websocket发送数据
      2. 后端接收到websocket连接后，建立连接，并注册相关事件
         1. 收到前端的stdin数据，则将其发送到任务对应的STDIN管道
         2. 任务STDOUT/STDERR管道的内容通过websocket发送到前端
         3. websocket连接断开时不停止进程
5. 停止任务
6. 删除任务

前后端数据交互格式